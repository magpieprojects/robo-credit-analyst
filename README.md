# Credit Portfolio AI Analyst MVP

Business Intelligence MVP that explains changes in portfolio credit risk between two reporting dates using:
- Python
- SQLite (in-memory)
- Pandas
- OpenAI-compatible LLM APIs (OpenAI + Google Gemini)
- Streamlit

## What It Does
- Generates deterministic synthetic `risk_data` for:
  - `2024-01-31` (T0)
  - `2024-02-29` (T1)
  - asset class values: `stock`, `bond`, `real estate`, `private equity`, `hedge fund`
- Injects a known risk event for `BigCorp Inc`:
  - T0: `A`, PD `0.01`, Exposure `10,000,000`
  - T1: `BB`, PD `0.05`, Exposure `10,000,000`
- Runs a strict 3-step analyst loop:
  - Step 1: Portfolio WAPD trigger
  - Step 2: Customer contribution attribution
  - Step 3: Root-cause analysis + final summary sentence
- Includes a data explorer UI with:
  - left sidebar filters
  - group-by controls
  - aggregation controls
  - grouped asset-class comparison view with two selected dates as columns
  - step-by-step analysis and drill-down tables

## Project Structure
- `app.py`: Full implementation (single source file)
- `pyproject.toml`: `uv` project metadata and dependencies
- `uv.lock`: Locked dependencies for reproducible installs

## Requirements
- Python `>=3.13`
- `uv` installed
- OpenAI API key or Google Gemini API key

## Install Dependencies
```bash
uv sync
```

## Run the App
```bash
uv run streamlit run app.py
```

Then in the UI:
1. Select provider (`OpenAI` or `Google Gemini`).
2. Enter the API key for that provider.
3. The app validates the key and loads only available valid models for that provider.
4. Use left sidebar controls to filter/group/aggregate the portfolio data table.
   - choose exactly two comparison dates
   - grouped view shows asset classes as rows with exposure and average PD columns per date
5. Select one of the listed models.
6. Click **Run Analysis**.
7. Review step-by-step analysis, drill-down output, and final note in the app.
8. Use the **Execution Window** (below LLM controls) to inspect logs, compiled SQL, and query results.

## Expected Console/Log Flow
```text
[Step 1] Analyzing Overall Portfolio...
   -> Found deviation of +X.XX%
[Step 2] Drilling down to Counterparty level...
   -> Identified 'BigCorp Inc' as primary driver.
[Step 3] Analyzing Root Cause...
   -> Detected Rating Downgrade (A -> BB).
[Final Report] "..."
```

## Notes
- SQL generated by the LLM is validated before execution:
  - single statement only
  - `SELECT` only
  - must reference `risk_data`
  - write/admin tokens are rejected
- Model selection is restricted to available models discovered from the selected provider.
- Gemini compatibility includes `gemini-flash-latest` via Google OpenAI-compatible endpoint.
- Database is recreated in-memory on every run.
- Do not commit real API keys. Keep secrets only in local runtime inputs or `.streamlit/secrets.toml`.
